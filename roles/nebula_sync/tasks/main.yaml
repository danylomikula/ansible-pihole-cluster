---
- name: Nebula-sync deployment
  when:
    - nebula_sync_enabled | default(true)
    - inventory_hostname in groups['master']
  tags:
    - nebula_sync
  block:
    - name: Ensure nebula-sync directory exists
      ansible.builtin.file:
        path: /opt/nebula-sync
        state: directory
        mode: "0755"

    - name: Deploy docker-compose.yml for nebula-sync
      ansible.builtin.template:
        src: "docker-compose.yml.j2"
        dest: /opt/nebula-sync/docker-compose.yml
        mode: "0644"

    - name: Deploy .env file for nebula-sync
      ansible.builtin.copy:
        content: "PIHOLE_PASSWORD='{{ pihole_web_password }}'"
        dest: /opt/nebula-sync/.env
        mode: "0600"
      no_log: true

    - name: Start nebula-sync container
      community.docker.docker_compose_v2:
        project_src: /opt/nebula-sync
        state: present
        pull: always
