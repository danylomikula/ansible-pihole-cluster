---
- name: Install unbound
  ansible.builtin.package:
    name: unbound
    state: present
  tags:
    - unbound

- name: Create unbound configuration
  ansible.builtin.template:
    dest: /etc/unbound/unbound.conf
    src: pi-hole.conf.j2
    mode: "0644"
  notify: Restart unbound service
  tags:
    - unbound

- name: Ensure dnsmasq.d directory exists
  ansible.builtin.file:
    path: /etc/dnsmasq.d
    state: directory
    mode: "0755"
  tags:
    - unbound

- name: Deploy EDNS configuration
  ansible.builtin.copy:
    src: 99-edns.conf
    dest: /etc/dnsmasq.d/99-edns.conf
    mode: "0644"
  notify: Restart unbound service
  tags:
    - unbound

- name: Check if resolvconf.conf exists
  ansible.builtin.stat:
    path: /etc/resolvconf.conf
  register: _unbound_resolvconf_exists
  changed_when: false
  tags:
    - unbound

- name: Disable resolvconf unbound integration
  ansible.builtin.lineinfile:
    path: /etc/resolvconf.conf
    regexp: '^unbound_conf='
    line: '#unbound_conf='
  when: _unbound_resolvconf_exists.stat.exists
  tags:
    - unbound

- name: Check if unbound resolvconf_resolvers.conf exists
  ansible.builtin.stat:
    path: /etc/unbound/unbound.conf.d/resolvconf_resolvers.conf
  register: _unbound_resolvconf
  changed_when: false
  tags:
    - unbound

- name: Remove unbound resolvconf_resolvers.conf
  ansible.builtin.file:
    path: /etc/unbound/unbound.conf.d/resolvconf_resolvers.conf
    state: absent
  when: _unbound_resolvconf.stat.exists
  notify: Restart unbound service
  tags:
    - unbound

- name: Ensure unbound service is started and enabled
  ansible.builtin.systemd:
    name: unbound
    state: started
    enabled: true
  tags:
    - unbound

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Verify unbound service is running
  ansible.builtin.systemd:
    name: unbound
  register: _unbound_status
  retries: 5
  delay: 3
  until: _unbound_status.status.ActiveState == 'active'
  tags:
    - unbound
